### Apache Kafka �����ڴ���������Ŷ��У����� Uber �� Crowdstrike ��������������ʵ���Ͱ����о���





ʶ��ʹ����������κοɿ����������ܵ����Ǳز����ٵġ���ƪ����̽����** �� Apache Kafka �����ܹ���****ʹ�����Ŷ���ʵ�ִ���������ʵ��**����Щѡ������Զ���ʵ�֡�Kafka Streams��Kafka Connect��Spring ��ܺͲ��������ߡ���ʵ�����о�չʾ�� Uber��CrowdStrike ��ɣ̹����������Լ��˹�ģ�����ɿ���ʵʱ������





Apache Kafka ��Ϊ�����ҵ�ܹ���ϲ���ļ����м������ʹ����������ս�ԣ���ҵҲ�������� Kafka ����������Ϊ��ԭ������ƽ̨������ (iPaaS)��





### Apache Kafka �������е���Ϣ����ģʽ





���ҿ�ʼ��ƪ����֮ǰ����������֪�����������**���ڡ�JMS����Ϣ���к� Apache Kafka���Ĳ���ϵ��**��һ���֣�





*   JMS ��Ϣ������ Apache Kafka ��������**10 ���Ƚϱ�׼**
*   _**��ƪ����**_**�C ͨ��Apache Kafka �е����Ŷ��� (DQL)**���д�������������
*   ʹ�� Apache Kafkaʵ��**����-�ظ�ģʽ**
*   _����_�Ƴ�����**����ѡ����ȷ��Ϣϵͳ�ľ�����**��JMS �� Apache Kafka��
*   _�����Ƴ�_������ JMS ��Ϣ���� Apache Kafka��**���ɡ�Ǩ�ƺ�/���滻**





### ʲô�����Ŷ��м���ģʽ���� Apache Kafka �У���





**���Ŷ��� (DLQ)**����Ϣϵͳ��������ƽ̨�ڵ�һ�ַ���ʵ�֣�����**�洢δ�ɹ��������Ϣ**��ϵͳ���Ǳ�����ת����Ϣ�����ǽ����ƶ������Ŷ��С�





��ҵ**����ģʽ (EIP)**��Ϊ�������ģʽ����ͨ�������ǿ��Խ���������ͬ��ʡ�






![image-20230526224702433](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526224702433.png)





�����ص����������ƽ̨ Apache Kafka��**�� Kafka �н���Ϣ���� DLQ ��**��Ҫԭ��ͨ������Ϣ��ʽ�������Ϣ������Ч/ȱʧ�����磬���Ԥ��ֵ���������������߷������ַ�������ᷢ��Ӧ�ó�������ڸ���̬�Ļ����У������ⲻ���ڡ��쳣�������޷�������Ϣ����һ������





��ˣ�ͨ����Ҫʹ�������м�������е�֪ʶ��Message Queue �м��������� JMS �� IBM MQ��TIBCO EMS �� RabbitMQ����ֲ�ʽ�ύ��־���� Kafka���Ĺ�����ʽ��ͬ�������������ԭ����Ϣ�����е� DLQ ������Ϣ����ϵͳ����Щԭ����һ��һ��ӳ�䵽 Kafka�����磬MQ ϵͳ�е���Ϣ����ÿ����Ϣ�� TTL������ʱ�䣩�����ڡ�





��ˣ�**�� Kafka �н���Ϣ���� DLQ ����Ҫԭ������Ϣ��ʽ�������Ϣ������Ч/ȱʧ**��





### Apache Kafka �����Ŷ��е��������





Kafka �е����Ŷ�����һ������ Kafka ���⣬����**���պʹ洢���ڴ�����޷�����һ�����ܵ��д������Ϣ**���˸�������ʹ�����´�����Ϣ������Ϣ����������������Ч��Ϣ�Ĵ����ֹͣ��������





### Kafka Broker �ܱ��������ܶ˵��ṩ������





**Kafka �ܹ���֧�� broker** r �е�DLQ������أ�Kafka ���������ִ�΢������ͬ��ԭ���ϣ�ʹ�á��ƹܵ������ܶ˵㡱ԭ�������Ϊʲô�봫ͳ��Ϣ������ȣ�Kafka ����չ�����֮�á����˺ʹ��������ڿͻ���Ӧ�ó����С�





������ƽ̨�������������ʵ�ָ��ɾ�������������ơ�**ÿ��΢�����Ӧ�ó���ͨ���Լ�ѡ��ļ�����ͨ�ŷ�ʽ�ʹ�������ʵ�����߼�**��





�ڴ�ͳ���м������Ϣ�����У������ṩ�������߼�����������еĿ���չ�Ժ�����Խϲ��Ϊֻ���м���ŶӲ���ʵ�ּ����߼���





### ���κα�������Զ���ʵ�� Kafka ���Ŷ���





Kafka �е����Ŷ��ж�������ʹ�õĿ�ܡ�һЩ���Ϊ����������Ŷ����ṩ�˿��伴�õĹ��ܡ����ǣ�ʹ��Java��Go��C++��Python ��**�κα������Ϊ Kafka Ӧ�ó����д���Ŷ����߼�**Ҳ�����ס�





**���Ŷ���ʵ��**��Դ�������һ�� try-catch ��������Ԥ�ڻ������쳣�����û�з��������������Ϣ����������κ��쳣���뽫��Ϣ���͵�ר�õ� DLQ Kafka ���⡣





**ʧ��ԭ��Ӧ��ӵ� Kafka ��Ϣ�ı�ͷ**�С���Ӧ���ļ���ֵ���Ա㽫������ʷ�¼��������´���͹��Ϸ�����





### ���Ŷ��еĿ��伴�� Kafka ʵ��





�㲢��������Ҫʵ��������Ŷ��С�**�������Ϳ���Ѿ��ṩ�����ǵ� DLQ ʵ��**��





ʹ�����Լ���Ӧ�ó�����ͨ�����Կ��ƴ�����ڳ��ִ���ʱ�޸����롣���ǣ�**�� 3rd ��Ӧ�ó���ļ��ɲ���һ��������������ܿ缯���ϰ�����Ĵ���**����ˣ�DLQ ��ø�����Ҫ������������ĳЩ����С�





### Kafka Connect �������Ŷ���





**Kafka Connect �� Kafka �ļ��ɿ��**���������ڿ�Դ Kafka �����С�����Ҫ������������������� Connect ��Ⱥ�е�������������





Ĭ������£��������ʹ����Ч��Ϣ��������������ʹ�ô���� JSON ת������������ȷ�� AVRO ת����ʱ����Kafka Connect ����ֹͣ��ɾ����Ч��Ϣ����һ��ѡ�񡣺������̴���





Kafka Connect �� DLQ �����úܼ򵥡�ֻ�轫��������ѡ�� ' errors.tolerance' �� ' errors.deadletterqueue.topic.name' ��ֵ����Ϊ��ȷ��ֵ��






![image-20230526224856544](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526224856544.png)





�������¡� Kafka Connect Deep Dive �C ����������Ŷ��С���ʾ��ʹ�� DLQ ����ϸ���ִ���ʾ����





**Kafka Connect �����������ڴ��� DLQ �еĴ�����Ϣ**��ֻ�貿����һ��ʹ�� te DLQ ����������������磬�������Ӧ�ó����� Avro ��Ϣ���Ҵ�����Ϣ�� JSON ��ʽ��Ȼ��������ʹ�� JSON ��Ϣ������ת��Ϊ AVRO ��Ϣ�Գɹ����´���






![](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/61aa7624a01c5016d3ab9aaa8ee6938d5514.jpeg)��ע�⣬Kafka Connect **û������Դ�����������Ŷ���**��





### Kafka Streams Ӧ�ó����еĴ�����





**Kafka Streams �� Kafka ���������**��������������ʽ������������������ Apache Flink��Storm��Beam �����ƹ��ߡ����ǣ����� Kafka ԭ���ġ�����ζ���������ڵ�������չ�ҿɿ��Ļ����ܹ��й��������Ķ˵�����������





������ֱ�ʹ�� Java��JVM ��̬ϵͳ�������� Kafka Ӧ�ó���**���鼸������ʹ�� Kafka Streams ������ Kafka �ı�׼ Java �ͻ���**��Ϊʲô��





*   Kafka Streams��ֻ�ǡ�һ��Χ�Ƴ��� Java �����ߺ������� API �İ�װ�����Լ�������õĸ��ӹ��ܡ�
*   ���߶�ֻ��Ƕ�뵽 Java Ӧ�ó����еĿ⣨JAR �ļ�����
*   ���߶��ǿ�Դ Kafka ���ص�һ���� - û�ж��������������֤���ġ�
*   ��������Ѿ����伴�õؽ�����Թ����������������������ܡ���״̬��Ƕ��ʽ�洢���������ڡ�����ʽ��ѯ��������ȵȣ���





Kafka Streams��**���ù���֮һ��Ĭ�ϵķ����л��쳣�������**���������������޷������л���**��¼�쳣��**�𻵵����ݡ�����ȷ�����л��߼���δ����ļ�¼���Ͷ����ܵ��´��󡣸ù��ܲ���Ϊ���Ŷ��У������伴�õؽ������ͬ�����⡣





### Spring Kafka �� Spring Cloud Stream �Ĵ�����





Spring ��ܶ� Apache Kafka �кܺõ�֧�֡����ṩ�����ģ���Ա����Լ���д������롣**Spring-Kafka �� Spring Cloud Stream Kafka ֧�ָ������Ժʹ�����ѡ��**����������ʱ��/���������ԡ����Ŷ��еȡ�





���� Spring ��ܹ��ܷǳ��ḻ�������е��أ�������һ��ѧϰ���ߡ���ˣ����ǳ��ʺ��½���Ŀ������������Ѿ��� Spring ����������������Ŀ��





�кܶ�ܰ��Ĳ�������չʾ�˲�ͬ��ʾ��������ѡ������������Ŷ��еĹٷ� Spring Cloud Stream ʾ����Spring ����ʹ�ü򵥵�ע�͹����߼������� DLQ�����ֱ�̷�����һЩ������Ա�Ӱ��ķ���������һЩ��ϲ������ֻ���˽�ѡ�Ϊ�Լ�ѡ����ʵ�ѡ��ɡ�





### Apache Kafka ���������ߵĿ���չ����ʹ�����





�����ͻ��Ի��У���ʵ֤����**�������Ŷ��е���Ҫԭ��ͨ���Ǵ������ӵ��ⲿ Web ��������ݿ��ʧ��**����ʱ�� Kafka �޷����з��͸�������ᵼ��ĳЩӦ�ó���̱�������������һ���ܺõĽ��������





Apache Kafka��**����������**��Apache 2.0 �����**�Ŀ�Դ��Ŀ��**���ṩ��һ�����пͻ��˶��еĲ��� Apache Kafka �ͻ��˰�װ����һ������**�ؼ������Եĸ��򵥵�������/������ API��**�Լ�**����չ�ķ����� IO**����





�ÿ�������**ͨ������ Kafka Consumer ���д�����Ϣ������ζ���������ڲ�����**Ҫ����������еķ������������������ Kafka Consumer ���жȡ�**���������������ͨ������ Kafka ����ĸ�����**������������ӳ١������������µ����������缫�˲����ԡ��ⲿ���ݷḻ���Ŷӡ�





һ���ؼ�������**�ڵ��� Kafka ������Ӧ�ó����д���/�ظ� Web ��������ݿ����**�����л�������һ�η��͵��� Web �������Ҫ��






![image-20230526224910457](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526224910457.png)





**Parallel Consumer �ͻ��˾���ǿ�������**�߼�������������õ��ӳٺͶ�̬�����������Ҳ���Է��͵����Ŷ��С�





### ʹ�����Ŷ����е���Ϣ





**�������͵����Ŷ��к�����û����ɣ�����Ϣ��Ҫ����������ٱ���أ�**





���Ŷ�����**���¼������д��⴦�����ݴ�����**�ľ��ѷ�ʽ������ζ�Ŵ��������������¼��������ֿ��������ݱ䡣





���ڴ���ʹ�����Ŷ��еĴ�������ԡ�DO �� DONT ̽�����ʵ���;����ѵ��





### ���������





�м���ѡ������ڴ���洢�����Ŷ����е���Ϣ��





*   **���´���**��DLQ�е�һЩ��Ϣ��Ҫ���´������ǣ����ȣ���Ҫ���������⡣��������������Զ��ű����༭��Ϣ���˹����������������߷��ش���Ҫ�����·��ͣ������ģ���Ϣ��
*   **ɾ��������Ϣ��������һ��������**�������������ã����ܻ���ִ�����Ϣ�����ǣ���ɾ������֮ǰ��ҵ������Ӧ�ü�����ǡ����磬�Ǳ��Ӧ�ó������ʹ�ô�����Ϣ�������ǿ��ӻ���
*   **�߼�����**����һ��ѡ���Ƿ������������Ի�ȡʵʱ��������⣬�����Ǵ��� DLQ �е�ÿ����Ϣ�����磬һ���򵥵� ksqlDB Ӧ�ó������Ӧ����������м��㣬����ÿСʱ������Ϣ��ƽ���������κ�����������ȷ�� Kafka Ӧ�ó����еĴ���ļ��⡣
*   **ֹͣ������**��������ٻ���ֻ���Ϣ�����������ֹͣ����ҵ�����̡��ö����������Զ��ģ�Ҳ�������˾�������Ȼ��ֹͣ������Ҳ�������׳������ Kafka Ӧ�ó�������ɡ������Ҫ��DLQ ������;����ⲿ����
*   **����**����������������������ѡ��ֻ�������Ŷ���������ʲô��������Ȼ������ʹ������ĳЩ������Ҳ�ܺã������� Kafka Ӧ�ó����������Ϊ�����ס��Kafka ������б���ʱ�䣬�����ڸ�ʱ��֮���������ɾ����Ϣ��ֻ��Ϊ��������ȷ�ķ�ʽ���ɡ������ DQL �����Ƿ����������Ϊ���������̫�죩��





### Apache Kafka �����Ŷ��е����ʵ��





�������� Kafka Ӧ�ó�����ʹ�����Ŷ��н��д������һЩ**���ʵ���;����ѵ��**





*   ����**������Ч��Ϣ��ҵ������**���Զ����˹���
    *   ��ʵ��ͨ��������û���˴��� DLQ ��Ϣ
    *   ��ѡ���� 1��������������Ҫ���վ��������������ǻ����ܹ��Ŷ�
    *   ��ѡ���� 2������Ӧ֪ͨ��¼�Ŷ�ϵͳ���ݴ������ǽ���Ҫ�Ӽ�¼ϵͳ���·���/�޸����ݡ�
    *   ���û���˹��Ļ�Թ���뿼�����ɺ���� DLQ ���ڵı�Ҫ�ԡ��෴����Щ��ϢҲ�����ڳ�ʼ Kafka Ӧ�ó����б����ԡ����ʡ�˴��������縺�ء�������ʩ���ʽ�
*   ����**�����ʵ��������Ǳ��**����������Ŷӣ����磬ͨ�������ʼ��� Slack ������
*   ����ÿ�� Kafka �����**���������ȼ���ֹͣ��ɾ�������´���**
*   **�����������ԵĴ�����Ϣ���͵� DLQ** - ����������������Ӧ�ó�������Ρ�
*   **����ԭʼ��Ϣ**�������Ǵ洢�� DLQ �У����ж���ı�ͷ�����������Ϣ������ʱ�䡢���������Ӧ�ó������Ƶȣ�������ʹ�����´���͹����ų���ø������ס�
*   **��������Ҫ���� Dead Letter Queue Kafka ����**��������ȡ�ᡣ���ǽ����д���洢�ڵ��� DLQ �п��ܶԽ�һ�����������´���û�����塣





���ס��**DLQ �����б�֤��˳����ֹ������ʹ�κ����͵����ߴ����ø�������**����ˣ�Kafka DQL �����ʺ�ÿ��������





### ��ʱ���� Kafka ��ʹ�����Ŷ��У�





������̽��һ�²�Ӧ�ý���Щ���͵���Ϣ���� Kafka �����Ŷ����У�





*   **DLQ ���ڱ�ѹ����**���ڴ�����Ϣ�ķ�ֵ��ʹ�� DLQ ���н���������һ�������⡣Kafka ��־����Ĵ洢���Զ�����ѹ���������������԰��Լ����ٶȻ�ȡ���ݵķ�ʽ��ȡ���ݣ��������ô��󣩡�������ܵĻ������Ե���չ�����ߡ���ʹ���Ĵ洢�ռ�������DLQ Ҳ�޼����¡������������⣬���Ƿ�ʹ�� DLQ �޹ء�
*   **����ʧ�ܵ�DLQ��**��������ʧ�ܶ�����Ϣ���� DQL �޼����£���ʹ�ڶ������֮�󣩡�������ϢҲ�޷����ӵ���ϵͳ������Ҫ����������⡣��Ϣ���Ը�����Ҫ�洢�ڳ��������У�ȡ���ڱ���ʱ�䣩��





### ������������ʹ���Ԥ����ģʽע���





���ͬ����Ҫ���ǣ�������̽����ĳЩ�����**�����������������Ŷ��е�����Ŀ����ԡ�**





**����**��Schema Registry**��һ��ȷ�����������Է�ֹ�������ڸ����г���ķ���**������ Kafka ��������ǿ��ִ����ȷ����Ϣ�ṹ��


![image-20230526224926155](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526224926155.png)





ģʽע�����ģʽ�Ŀͻ��˼�顣Confluent Server ��һЩʵ���ڴ�����ṩ�˶����ģʽ��飬�Ծܾ�����δʹ��ģʽע���������ߵ���Ч�������Ϣ��





### Kafka ���Ŷ��еİ����о�





�����ǿ���**Uber��CrowdStrike �� Santander Bank �����������о��������� Kafka ������ʩ��ʵ�ʲ������Ŷ���**�����ס����Щ���Ƿǳ���������ӡ�����ÿ����Ŀ����Ҫ��ô���ӡ�





### Uber - �����ɿ����ٴ�������Ŷ���





�ڷֲ�ʽϵͳ�У������ǲ��ɱ���ġ���������󵽸������⣬��������������ϵ���жϣ����ģ���еķ������׼���þ��������ŵ�������ʶ��ʹ�����ϡ�





���� Uber ����Ӫ��Χ���ٶȣ�����ϵͳ�������**�ݴ�����������������ʧ��ʱ������Э**��Uber �� Apache Kafka ���ڸ��ּ��˹�ģ��������ʵ����һĿ�ꡣ





������Щ���ԣ�Uber ���չ����Ŷ���չ�� Kafka ���������¼������ܹ��е����ã�ͨ��ʹ�� n**�������������´�������Ŷ�����ʵ�ֽ���ɹ۲�Ĵ������������ж�ʵʱ����**���ò�������������ѡ�����ļ�ʻԱ�˺������ƻ��� 200 ������пɿ����У���Ϊע���ʻԱ�۳�ÿ���г̵�ÿӢ�ﱣ�ѡ�





���� Uber �������ʾ��������ή����������ļ���ֱ����½ DLQ��






![](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526225030750.png)





�йظ�����Ϣ�����Ķ� Uber �ǳ���ϸ�ļ������£���ʹ�� Apache Kafka �����ɿ����ٴ�������Ŷ��С���





### CrowdStrike - �����������¼��Ĵ���





CrowdStrike ��һ��λ�ڵ¿���˹�ݰ�˹͡��**���簲ȫ������˾��**���ṩ**�ƹ������غͶ˵㰲ȫ����в�鱨�����繥����Ӧ����**��





CrowdStrike �Ļ�����ʩ** ÿ��ʹ�� Apache Kafka ���������ڸ��¼�**�����ҵġ� Apache Kaka ���簲ȫ����ϵ�С��У��ҽ��������κι�ģʵʱ����̬�Ƹ�֪����в�鱨�����������





CrowdStrike �������������ʵ�� ���ɹ�ʵ�����Ŷ��кʹ�����





*   **����ȷ��ϵͳ�д洢������Ϣ**�����������ʩ�ʹ����Բ���ͼ������š�CrowdStrike ʹ�� S3 ����洢���洢Ǳ�ڵĴ���������Ϣ����ע�⣬Kafka �ķֲ�洢���伴�õؽ����������⣬���������洢�ӿڣ����磬���� Confluent Cloud �е����޴洢����
*   **ʹ���Զ���**�����ù�����ʹ�޸�����һʧ����Ϊ�ֶ���ɴ�������ܷǳ����׳���
*   **��¼ҵ�����̲�Ƹ������Ŷ�**����׼���ͼ�¼������ȷ������ʹ�á��������й���ʦ����Ϥ��֯����������Ϣ�Ĳ��ԡ�





��**�� CrowdStrike ���������簲ȫƽ̨�У����ģʵʱ���ݴ���������Ҫ**����Ҫ��Ҳ�����ڴ�����**��һ�����繥�������ǹ���������ʵ�����Ч���ݵĶ�����Ϣ**���� JavaScript ©�����ã�����ˣ�����ͨ�����Ŷ���ʵʱ�������





### ɣ̹������ - �������Ժ� DLQ ��ϵ����� 2.0





ɣ̹������**������Ӧ�ó����д��������ݵ�ͬ�����ݴ������پ޴���ս**���������¼ܹ������ǵĻ����ܹ���������һ�������ҿ���չ�ļܹ�����Ϊ��Santander Mailbox 2.0����





Santander �Ĺ������ز�ת�Ƶ�**�� Apache Kafka �ṩ֧�ֵ��¼���Դ**��






![image-20230526225045196](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526225045196.png)





�µĻ����첽�¼��ļܹ��е�һ���ؼ���ս�Ǵ�����** Santander ʹ�����Ժ� DQL Kafka ���⹹���Ĵ�����**�������Щ���⣺






![image-20230526225057151](https://java-tutorial.oss-cn-shanghai.aliyuncs.com/image-20230526225057151.png)





�鿴���� Santander �ļ��ɺ������ Consdata�� Kafka ����ݽ����������Բ��Ժ���������� Apache Kafka �еĿɿ��¼����ݡ��е���ϸ��Ϣ��





### Apache Kafka �пɿ��ҿ���չ�Ĵ�����





**��������ڹ����ɿ����������ܵ���ƽ̨������Ҫ**�����ڲ�ͬ��������������������⡣�ý�������������Ŷ��е��Զ���ʵ�ֻ���������ʹ�õĿ�ܣ����� Kafka Streams��Kafka Connect��Spring ��ܻ� Kafka �Ĳ��������ߡ�





�Ų���CrowdStrike ��ɣ̹�����еİ����о������������������Ǻ�����ʵ�֡���������µ�Ӧ�ó����ܹ�ʱ����Ҫ��һ��ʼ�Ϳ��ǵ���һ�㡣**ʹ�� Apache Kafka ����ʵʱ�����������������������ֻ�������ܹ�����������Ϊʱ���ܳɹ�**�����Ŷ�������ೡ���ľ���ѡ��